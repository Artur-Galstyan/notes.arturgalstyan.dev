<!DOCTYPE html><html lang="en" data-theme="light"> <head><meta charset="utf-8"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="viewport" content="width=device-width"><meta name="generator" content="Astro v5.8.1"><title></title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css"><vercel-analytics data-props="{}" data-params="{}" data-pathname="/posts/mb-rl-experiments/"></vercel-analytics> <script type="module">var f="@vercel/analytics",l="1.5.0",w=()=>{window.va||(window.va=function(...r){(window.vaq=window.vaq||[]).push(r)})};function d(){return typeof window<"u"}function u(){try{const e="production"}catch{}return"production"}function v(e="auto"){if(e==="auto"){window.vam=u();return}window.vam=e}function m(){return(d()?window.vam:u())||"production"}function c(){return m()==="development"}function b(e,r){if(!e||!r)return e;let n=e;try{const t=Object.entries(r);for(const[a,i]of t)if(!Array.isArray(i)){const o=s(i);o.test(n)&&(n=n.replace(o,`/[${a}]`))}for(const[a,i]of t)if(Array.isArray(i)){const o=s(i.join("/"));o.test(n)&&(n=n.replace(o,`/[...${a}]`))}return n}catch{return e}}function s(e){return new RegExp(`/${h(e)}(?=[/?#]|$)`)}function h(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function y(e){return e.scriptSrc?e.scriptSrc:c()?"https://va.vercel-scripts.com/v1/script.debug.js":e.basePath?`${e.basePath}/insights/script.js`:"/_vercel/insights/script.js"}function g(e={debug:!0}){var r;if(!d())return;v(e.mode),w(),e.beforeSend&&((r=window.va)==null||r.call(window,"beforeSend",e.beforeSend));const n=y(e);if(document.head.querySelector(`script[src*="${n}"]`))return;const t=document.createElement("script");t.src=n,t.defer=!0,t.dataset.sdkn=f+(e.framework?`/${e.framework}`:""),t.dataset.sdkv=l,e.disableAutoTrack&&(t.dataset.disableAutoTrack="1"),e.endpoint?t.dataset.endpoint=e.endpoint:e.basePath&&(t.dataset.endpoint=`${e.basePath}/insights`),e.dsn&&(t.dataset.dsn=e.dsn),t.onerror=()=>{const a=c()?"Please check if any ad blockers are enabled and try again.":"Be sure to enable Web Analytics for your project and deploy again. See https://vercel.com/docs/analytics/quickstart for more information.";console.log(`[Vercel Web Analytics] Failed to load script from ${n}. ${a}`)},c()&&e.debug===!1&&(t.dataset.debug="false"),document.head.appendChild(t)}function p({route:e,path:r}){var n;(n=window.va)==null||n.call(window,"pageview",{route:e,path:r})}function k(){try{return}catch{}}customElements.define("vercel-analytics",class extends HTMLElement{constructor(){super();try{const r=JSON.parse(this.dataset.props??"{}"),n=JSON.parse(this.dataset.params??"{}");g({...r,disableAutoTrack:!0,framework:"astro",basePath:k(),beforeSend:window.webAnalyticsBeforeSend});const t=this.dataset.pathname;p({route:b(t??"",n),path:t})}catch(r){throw new Error(`Failed to parse WebAnalytics properties: ${r}`)}}});</script><link rel="stylesheet" href="/_astro/index.BMwjITTC.css"><script>window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
		var script = document.createElement('script');
		script.defer = true;
		script.src = '/_vercel/insights/script.js';
		var head = document.querySelector('head');
		head.appendChild(script);
	</script></head> <body class="bg-base-100 text-base-content"> <div class="container mx-auto px-4 py-8"> <nav class="bg-base-100 my-8"> <div class="navbar-start"> <div class="navbar-start"> <a href="/" class="normal-case text-2xl font-bold border border-base-300 p-4 rounded-lg shadow-sm">Artur's Notes</a> </div> </div> </nav> </div> <div class="flex justify-center"> <article class="prose w-full"> <h1 id="model-based-reinforcement-learning">Model-Based Reinforcement Learning</h1>
<p>Model-Based Reinforcement Learning (MBRL) is one of my favourite areas in machine learning in general. IMO, MBRL is likely going to be integral to finding AGI one day, because I believe that AGI (and intelligence in general) is simply a matter of <em>goal oriented next-state prediction</em>. I will leave this simply as an opinion and showcase my arguments for this at another time, because in this post, it’s all about coding MBRL.</p>
<p>Btw. this is <strong>not</strong> a tutorial, but rather a workthrough of MBRL and some of the issues encountered along the way.</p>
<p>Let’s start with the basics first. The goal of MBRL is to learn a model of the environment. The idea being that if you had a <em>perfect</em> model of the environment, then you could use that to plan a sequence of actions to get to your desired goal state. The difficulty is now to train that model, which should take in the current state <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span> and the performed action <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">a</span></span></span></span> as input and predict the next state <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>s</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">s'</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>. For this, we will just use a simple MLP (btw. we are training on CartPole for now - gotta start somewhere, right?):</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">class</span><span style="color:#6F42C1;--shiki-dark:#FFCB8B"> DynamicsModel</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#C5E478">eqx</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#C5E478">Module</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">):</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    mlp</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> eqx</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">nn</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#82AAFF">MLP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    n_dims</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> eqx</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">field</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#D7DBE0">static</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#FF5874">True</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    n_actions</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> eqx</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">field</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#D7DBE0">static</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#FF5874">True</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">    def</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> __init__</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#FF9800;--shiki-dark:#7FDBCA">self</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> n_dims</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> n_actions</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> key</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> PRNGKeyArray</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#8EACE3">        self</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">mlp </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> eqx</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">nn</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">MLP</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D7DBE0">            in_size</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">n_dims </span><span style="color:#D32F2F;--shiki-dark:#C792EA">+</span><span style="color:#212121;--shiki-dark:#82AAFF"> n_actions</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D7DBE0">            out_size</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">n_dims</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D7DBE0">            width_size</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#F78C6C">32</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D7DBE0">            depth</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#F78C6C">2</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D7DBE0">            key</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">key</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">        )</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#8EACE3">        self</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">n_dims </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> n_dims</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#8EACE3">        self</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">n_actions </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> n_actions</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">    def</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> __call__</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#FF9800;--shiki-dark:#7FDBCA">self</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> x</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> Float</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D"> n_dims+n_actions</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#212121;--shiki-dark:#D6DEEB"> -></span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> Float</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">n_dims</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        state </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> x</span><span style="color:#212121;--shiki-dark:#D6DEEB">[:</span><span style="color:#24292EFF;--shiki-dark:#8EACE3"> self</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">n_dims</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        delta </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#8EACE3"> self</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">mlp</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">x</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">        return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> state </span><span style="color:#D32F2F;--shiki-dark:#C792EA">+</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> delta</span></span></code></pre>
<p>Admittedly, this is not the purest MLP, because we are using residual connections, i.e. we are trying to learn the delta between the current state and the next state. The argument is that usually there is not such a drastic change between states, thus being easier to learn the delta than the whole thing.</p>
<p>Ok, so now we have a dynamics prediction model (we have no idea yet if it works or not though). One thing we will need for sure is <strong>data</strong>! One of the advantages of MBRL is that all data is good data, in the sense that you have no reason to throw out any data, since all the data you collect comes from the environment i.e. the ground truth.</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">def</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic"> collect_data</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    env</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> gym</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">Env</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_episodes</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    dynamics_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    reward_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    epsilon</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> float</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 0.1</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_horizon</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 10</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#212121;--shiki-dark:#D6DEEB"> -></span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> list</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">tuple</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">]]</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    data </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD"> []</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">    for</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> i </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">in</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> range</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">n_episodes</span><span style="color:#212121;--shiki-dark:#D6DEEB">):</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        state</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> _ </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> env</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">reset</span><span style="color:#212121;--shiki-dark:#D6DEEB">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        terminated</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> truncated </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#FF5874"> False</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#1976D2;--shiki-dark:#FF5874"> False</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">        while</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> not</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> terminated </span><span style="color:#D32F2F;--shiki-dark:#C792EA">and</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> not</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> truncated</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">            if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> random</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">random</span><span style="color:#212121;--shiki-dark:#D6DEEB">()</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> &#x3C;</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> epsilon</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">                action </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> env</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">action_space</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">sample</span><span style="color:#212121;--shiki-dark:#D6DEEB">()</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">            else</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">                action </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#FFFFFF">????</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            next_state</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> reward</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> terminated</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> truncated</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> _ </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> env</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">step</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">action</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            data</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">append</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">(state, action, reward, next_state)</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">    return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> data</span></span></code></pre>
<p>The above function is simple: just create <code>n_episode</code> worth of data using epsilon-greedy exploration, i.e. 10 % random exploration (in this example). But what about the <code>else</code> part?</p>
<p>In the <code>else</code> branch, we have to specify <em>how</em> we should - in general - choose actions based on our model. I alluded to this earlier, namely that we need to plan ahead. Following the <a href="https://www.youtube.com/watch?v=VxyhEK4yW5g">talk from Sergey Levine</a>, you could use the cross-entropy method (CEM), which is a gradient-free planning method, although there are certainly other methods as well, such as Monte-Carlo Tree Search (MCTS). We will use CEM for now and later use MCTS to see the difference.</p>
<h2 id="excursion-cross-entropy-method">Excursion: Cross-Entropy Method</h2>
<p>CEM is a planning algorithm with the goal to give us the best action to take at the current state. It’s an iterative process, starting with a uniform distribution of actions and then morphing that into the best possible action probabilities (hence the name <em>cross-entropy</em> - you are trying to minimise the difference between a uniform distrubtion and the best distribution).</p>
<p>We need to give the algorithm also <code>n_horizon</code> which refers to how many steps into the future you should plan ahead. One of the problems with MBRL is compounding errors - namely the future ahead you plan, the more the small errors from your dynamics model pile up, eventually given a prediction which could be far away from the truth (software developers have the same problem - rarely have plans for a projects worked and yet we throw shade at MBRL algorithms for not being able to plan ahead…).</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#C5E478">@</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#C5E478;--shiki-dark-font-style:italic">eqx</span><span style="color:#212121;--shiki-dark:#C5E478">.</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#C5E478;--shiki-dark-font-style:italic">filter_jit</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">def</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic"> reward_model_planning</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    dynamics_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> DynamicsModel</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    reward_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> RewardModel</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    initial_state</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_horizon</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 10</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_samples</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 100</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_iterations</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 5</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_elite</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 10</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_actions</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 2</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span></code></pre>
<p>Wait, what the hell is this <code>RewardModel</code> - you might be asking, rightfully so since I haven’t introduced that yet.</p>
<p>We are trying to plan ahead into the future and evaluate each trajectory. But how good is the trajectory?</p>
<p><img src="/posts/mb-rl-experiments/cem1.png" alt="Cross-Entropy Method for planning in Model-Based RL"></p>
<p>Our dynamics model can predict the next state, but it can’t predict the next reward. What makes this situation even more difficult is that in our environment (i.e. CartPole) the reward is always <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>. So, our reward model looks like this:</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">class</span><span style="color:#6F42C1;--shiki-dark:#FFCB8B"> RewardModel</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#C5E478">eqx</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#C5E478">Module</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">):</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    mlp</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> eqx</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">nn</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#82AAFF">MLP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    n_dims</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> eqx</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">field</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#D7DBE0">static</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#FF5874">True</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    n_actions</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> eqx</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">field</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#D7DBE0">static</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#FF5874">True</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">    def</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> __init__</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#FF9800;--shiki-dark:#7FDBCA">self</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> n_dims</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> n_actions</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> key</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> PRNGKeyArray</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#8EACE3">        self</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">mlp </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> eqx</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">nn</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">MLP</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D7DBE0">            in_size</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">n_dims </span><span style="color:#D32F2F;--shiki-dark:#C792EA">+</span><span style="color:#212121;--shiki-dark:#82AAFF"> n_actions</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D7DBE0">            out_size</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#F78C6C">1</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D7DBE0">            width_size</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#F78C6C">32</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D7DBE0">            depth</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#F78C6C">2</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D7DBE0">            key</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">key</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">        )</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#8EACE3">        self</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">n_dims </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> n_dims</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#8EACE3">        self</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">n_actions </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> n_actions</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">    def</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> __call__</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#FF9800;--shiki-dark:#7FDBCA">self</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> x</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> Float</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">n_dims+n_actions</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#212121;--shiki-dark:#D6DEEB"> -></span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> Float</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> ""</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">        return</span><span style="color:#24292EFF;--shiki-dark:#8EACE3"> self</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">mlp</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">x</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span></code></pre>
<p>And it takes as input the current state and action and returns a scalar, which is the predicted reward. Later, during training, you will notice that the loss of this reward model quickly drops to 0 so it’s actually not all that useful (it’s not that hard to predict 1 <em>every single time</em>). A much better way to estimate reward for the CartPole environment would be to make it dependent on the angle and velocity of the cart. But hand crafting rewards like this will quickly fall apart and does not scale and is not general enough (what’s the ideal reward function for LunarLander?).</p>
<p>But because we have no other option right now, we will use this reward model.</p>
<p>Now comes the initial action probability.</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">action_probs </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">ones</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">(n_horizon, n_actions)</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> /</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> n_actions</span></span></code></pre>
<p><img src="/posts/mb-rl-experiments/cem2.png" alt="Initial Action Probabilities"></p>
<p>These numbers assume <code>n_actions=4</code> and the y axis corresponds to the timesteps while the x axis is the probability for that action at that timestep. The goal is to find the “optimal” action probabilities, e.g.:</p>
<p><img src="/posts/mb-rl-experiments/cem3.png" alt="Optimal Action Probabilities"></p>
<p>In this example, the best action sequence to pick is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">a_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> at <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">t_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">a_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> at <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">t_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">a_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> at <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">t_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and so on and lastly <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">a_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> at <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">t_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></p>
<p>In my implementation, since I use JAX, there are a few JAX-ish things happening, lots of <code>vmap</code> and <code>jax.lax.scan</code> action going on. We can leverage these to parallelise a lot of computations and we can do that, because the CEM algorithm doesn’t depend on the actual environment - that’s what we use the dynamics model for.</p>
<p>Ok so here’s the entire code and I will cover a few of the more relevant parts of it:</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">def</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic"> reward_model_planning</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    dynamics_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> DynamicsModel</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    reward_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> RewardModel</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    initial_state</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_horizon</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 10</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_samples</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 100</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_iterations</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 5</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_elite</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 10</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_actions</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 2</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    action_probs </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">ones</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">(n_horizon, n_actions)</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> /</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> n_actions</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">    def</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic"> simulate_step</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#FF9800;--shiki-dark:#7FDBCA">action_sequences</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> dynamics_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> reward_model</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        def</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic"> step_trajectory</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#FF9800;--shiki-dark:#7FDBCA">state_and_idx</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> timestep</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            sample_idx</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> current_state </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> state_and_idx</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            action </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> action_sequences</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">sample_idx</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> timestep</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            action_one_hot </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">zeros</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">n_actions</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            action_one_hot </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> action_one_hot</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">at</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">action</span><span style="color:#212121;--shiki-dark:#D6DEEB">].</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">set</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#1976D2;--shiki-dark:#F78C6C">1.0</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            model_input </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">concatenate</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#D9F5DD">[</span><span style="color:#212121;--shiki-dark:#82AAFF">current_state, action_one_hot</span><span style="color:#212121;--shiki-dark:#D9F5DD">]</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            reward </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6"> reward_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">model_input</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            next_state </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6"> dynamics_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">model_input</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">            return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (sample_idx</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> next_state)</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> reward</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">        return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> step_trajectory</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">    def</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic"> evaluate_trajectory</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#FF9800;--shiki-dark:#7FDBCA">sample_idx</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> trajectory_stepper</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        state </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> initial_state</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        _</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> rewards </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">lax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">scan</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D7DBE0">            f</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">trajectory_stepper</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> init</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">(sample_idx, state)</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> xs</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">jnp.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">arange</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">n_horizon</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">        )</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        total_reward </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">sum</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">rewards</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">        return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> total_reward</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">    def</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic"> iterate</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#FF9800;--shiki-dark:#7FDBCA">carry</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> x</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        action_probs </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> carry</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        keys </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">random</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">split</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">jax.random.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">PRNGKey</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">x</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> n_samples</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        def</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic"> sample_actions</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#FF9800;--shiki-dark:#7FDBCA">key</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">            return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">vmap</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">                lambda</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> p</span><span style="color:#212121;--shiki-dark:#82AAFF">, </span><span style="color:#FF9800;--shiki-dark:#7FDBCA">k</span><span style="color:#212121;--shiki-dark:#82AAFF">: jax.random.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">choice</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">k</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> jnp.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">arange</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">n_actions</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> p</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">p</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">            )(</span><span style="color:#212121;--shiki-dark:#82AAFF">action_probs</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> jax.random.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">split</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">key</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> n_horizon</span><span style="color:#212121;--shiki-dark:#D6DEEB">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        action_sequences </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">vmap</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">sample_actions</span><span style="color:#212121;--shiki-dark:#D6DEEB">)(</span><span style="color:#212121;--shiki-dark:#82AAFF">keys</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        trajectory_stepper </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6"> simulate_step</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">            action_sequences</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> dynamics_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> reward_model</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">        )</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        trajectory_evaluator </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> functools</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">partial</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">            evaluate_trajectory</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> trajectory_stepper</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">trajectory_stepper</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">        )</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        trajectory_rewards </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> eqx</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">filter_vmap</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">trajectory_evaluator</span><span style="color:#212121;--shiki-dark:#D6DEEB">)(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">            jnp.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">arange</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">n_samples</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        elite_indices </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">argsort</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">trajectory_rewards</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">[</span><span style="color:#D32F2F;--shiki-dark:#C792EA">-</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">n_elite</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">]</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        elite_actions </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> action_sequences</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">elite_indices</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        action_probs </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">mean</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">elite_actions</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> axis</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#F78C6C">0</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        new_action_probs </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">zeros_like</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">action_probs</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        elite_actions_one_hot </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">nn</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">one_hot</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">elite_actions</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> n_actions</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        new_action_probs </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">mean</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">elite_actions_one_hot</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> axis</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#F78C6C">0</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">        return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> new_action_probs</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#1976D2;--shiki-dark:#FF5874"> None</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    action_probs</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> _ </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">lax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">scan</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">        iterate</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> init</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">(action_probs)</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> xs</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">jnp.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">arange</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">n_iterations</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    keys </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">random</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">split</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">jax.random.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">PRNGKey</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">n_iterations</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> n_samples</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">    def</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic"> sample_final_actions</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#FF9800;--shiki-dark:#7FDBCA">key</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">        return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">vmap</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">lambda</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> p</span><span style="color:#212121;--shiki-dark:#82AAFF">, </span><span style="color:#FF9800;--shiki-dark:#7FDBCA">k</span><span style="color:#212121;--shiki-dark:#82AAFF">: jax.random.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">choice</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">k</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> jnp.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">arange</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">n_actions</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> p</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">p</span><span style="color:#212121;--shiki-dark:#D6DEEB">))(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">            action_probs</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> jax.random.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">split</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">key</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> n_horizon</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    final_action_sequences </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">vmap</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">sample_final_actions</span><span style="color:#212121;--shiki-dark:#D6DEEB">)(</span><span style="color:#212121;--shiki-dark:#82AAFF">keys</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    final_trajectory_stepper </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6"> simulate_step</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">        final_action_sequences</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> dynamics_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> reward_model</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">    )</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    final_evaluator </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> functools</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">partial</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">        evaluate_trajectory</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> trajectory_stepper</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">final_trajectory_stepper</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">    )</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    final_rewards </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> eqx</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">filter_vmap</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">final_evaluator</span><span style="color:#212121;--shiki-dark:#D6DEEB">)(</span><span style="color:#212121;--shiki-dark:#82AAFF">jnp.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">arange</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">n_samples</span><span style="color:#212121;--shiki-dark:#D6DEEB">))</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    best_idx </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">argmax</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">final_rewards</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    best_first_action </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> final_action_sequences</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">best_idx</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 0</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">    return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> best_first_action</span></span></code></pre>
<p>The top level call to get the <code>action_probs</code> is this</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">action_probs</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> _ </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">lax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">scan</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">        iterate</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> init</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">(action_probs)</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> xs</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">jnp.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">arange</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">n_iterations</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">    )</span></span></code></pre>
<p>If you didn’t know, <code>jax.lax.scan</code> is a JAX primitive and I have created <a href="https://www.youtube.com/watch?v=JRbL_ETqdxc">a video on that</a> - it kind of works like a for loop with a carry. The function we use in the loop is the <code>iterate</code> function.</p>
<p>In the <code>iterate</code> function, we first sample the actions to get the <code>action_sequences</code> array which has the shape <code>n_samples x n_horizon</code>.</p>
<p>This part</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">trajectory_stepper </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6"> simulate_step</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">    action_sequences</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> dynamics_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> reward_model</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span></code></pre>
<p>creates the stepper <strong>function</strong>, which will be called inside the <code>evaluate_trajectory</code> function:</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">def</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic"> evaluate_trajectory</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#FF9800;--shiki-dark:#7FDBCA">sample_idx</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> trajectory_stepper</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    state </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> initial_state</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    _</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> rewards </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">lax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">scan</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D7DBE0">        f</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">trajectory_stepper</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> init</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">(sample_idx, state)</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> xs</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">jnp.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">arange</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">n_horizon</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">    )</span><span style="color:#C2C3C5;font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic"> # basically just simulate n_horizon steps</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    total_reward </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">sum</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">rewards</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">    return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> total_reward</span></span></code></pre>
<p>Inside the <code>trajectory_stepper</code> function, we use the dynamics model to estimate the next state and use the reward model to estimate the reward, which in turn tells us how good this specific trajectory is.</p>
<p>With this <code>vmap</code></p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">trajectory_rewards </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> eqx</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">filter_vmap</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">trajectory_evaluator</span><span style="color:#212121;--shiki-dark:#D6DEEB">)(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">    jnp.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">arange</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">n_samples</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span></code></pre>
<p>We compute all the trajectories (i.e. all the samples) in parallel and we can do that because each sample is independent of each other. Very efficient stuff!</p>
<p>This part</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">elite_indices </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">argsort</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">trajectory_rewards</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">[</span><span style="color:#D32F2F;--shiki-dark:#C792EA">-</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">n_elite</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">]</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">elite_actions </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> action_sequences</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">elite_indices</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">action_probs </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">mean</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">elite_actions</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> axis</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#F78C6C">0</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">new_action_probs </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">zeros_like</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">action_probs</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">elite_actions_one_hot </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">nn</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">one_hot</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">elite_actions</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> n_actions</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">new_action_probs </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">mean</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">elite_actions_one_hot</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> axis</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#F78C6C">0</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> new_action_probs</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#1976D2;--shiki-dark:#FF5874"> None</span></span></code></pre>
<p>basically just gets the best trajectories and computes the average of the best action probabilities (this is the cross-entropy part).</p>
<p>We then do one last evaluation, to get the best action:</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">action_probs</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> _ </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">lax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">scan</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">    iterate</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> init</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">(action_probs)</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> xs</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">jnp.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">arange</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">n_iterations</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">keys </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">random</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">split</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">jax.random.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">PRNGKey</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">n_iterations</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> n_samples</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">def</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic"> sample_final_actions</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#FF9800;--shiki-dark:#7FDBCA">key</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">    return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">vmap</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">lambda</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> p</span><span style="color:#212121;--shiki-dark:#82AAFF">, </span><span style="color:#FF9800;--shiki-dark:#7FDBCA">k</span><span style="color:#212121;--shiki-dark:#82AAFF">: jax.random.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">choice</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">k</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> jnp.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">arange</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">n_actions</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> p</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">p</span><span style="color:#212121;--shiki-dark:#D6DEEB">))(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">        action_probs</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> jax.random.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">split</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">key</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> n_horizon</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">final_action_sequences </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">vmap</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">sample_final_actions</span><span style="color:#212121;--shiki-dark:#D6DEEB">)(</span><span style="color:#212121;--shiki-dark:#82AAFF">keys</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">final_trajectory_stepper </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6"> simulate_step</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">    final_action_sequences</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> dynamics_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> reward_model</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">final_evaluator </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> functools</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">partial</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">    evaluate_trajectory</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> trajectory_stepper</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">final_trajectory_stepper</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">final_rewards </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> eqx</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">filter_vmap</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">final_evaluator</span><span style="color:#212121;--shiki-dark:#D6DEEB">)(</span><span style="color:#212121;--shiki-dark:#82AAFF">jnp.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">arange</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">n_samples</span><span style="color:#212121;--shiki-dark:#D6DEEB">))</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">best_idx </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">argmax</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">final_rewards</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">best_first_action </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> final_action_sequences</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">best_idx</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 0</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> best_first_action</span></span></code></pre>
<h2 id="back-to-mbrl">Back to MBRL</h2>
<p>There are a few things we could improve in the CEM algorithm but the biggest issue is the way we compute the rewards, which is kind of meaningless: it does not differentiate between the pole being upright in the middle and being almost horizontal; in both cases you get a reward of 1. Ideally, you should get more reward the slower and vertical the pole is.</p>
<p>Let’s update the <code>collect_data</code> function:</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">def</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic"> collect_data</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    env</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> gym</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">Env</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_episodes</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    dynamics_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    reward_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    epsilon</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> float</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 0.1</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_horizon</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 10</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#212121;--shiki-dark:#D6DEEB"> -></span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> list</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">tuple</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">]]</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    data </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD"> []</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">    for</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> i </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">in</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> range</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">n_episodes</span><span style="color:#212121;--shiki-dark:#D6DEEB">):</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        state</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> _ </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> env</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">reset</span><span style="color:#212121;--shiki-dark:#D6DEEB">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        terminated</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> truncated </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#FF5874"> False</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#1976D2;--shiki-dark:#FF5874"> False</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">        while</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> not</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> terminated </span><span style="color:#D32F2F;--shiki-dark:#C792EA">and</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> not</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> truncated</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">            if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> random</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">random</span><span style="color:#212121;--shiki-dark:#D6DEEB">()</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> &#x3C;</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> epsilon</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">                action </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> env</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">action_space</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">sample</span><span style="color:#212121;--shiki-dark:#D6DEEB">()</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">            else</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">                action </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B2CCD6">                    reward_model_planning</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                        dynamics_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> reward_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> state</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> n_horizon</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">n_horizon</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                    )</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                )</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            next_state</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> reward</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> terminated</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> truncated</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> _ </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> env</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">step</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">action</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            data</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">append</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">(state, action, reward, next_state)</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">    return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> data</span></span></code></pre>
<p>Assuming we have some data, we then need to train the models. This is standard JAX boilerplate. We use MSE loss for both models:</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#C5E478">@</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#C5E478;--shiki-dark-font-style:italic">eqx</span><span style="color:#212121;--shiki-dark:#C5E478">.</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#C5E478;--shiki-dark-font-style:italic">filter_value_and_grad</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">def</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic"> mse_loss</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#FF9800;--shiki-dark:#7FDBCA">model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> x</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> y</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    preds </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">vmap</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">model</span><span style="color:#212121;--shiki-dark:#D6DEEB">)(</span><span style="color:#212121;--shiki-dark:#82AAFF">x</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">    return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">mean</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">(preds </span><span style="color:#D32F2F;--shiki-dark:#C792EA">-</span><span style="color:#212121;--shiki-dark:#82AAFF"> y) </span><span style="color:#D32F2F;--shiki-dark:#C792EA">**</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 2</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#C5E478">@</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#C5E478;--shiki-dark-font-style:italic">eqx</span><span style="color:#212121;--shiki-dark:#C5E478">.</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#C5E478;--shiki-dark-font-style:italic">filter_jit</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">def</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic"> step</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#FF9800;--shiki-dark:#7FDBCA">model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> x</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> y</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> opt_state</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> optimizer</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    loss</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> grads </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6"> mse_loss</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> x</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> y</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    updates</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> opt_state </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> optimizer</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">update</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">grads</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> opt_state</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    model </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> eqx</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">apply_updates</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> updates</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">    return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> opt_state</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> loss</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">def</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic"> train_models</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    data</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    dynamics_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    reward_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_epochs</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    batch_size</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    learning_rate</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    optimizer</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    dynamics_opt_state</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    reward_opt_state</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    states </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">array</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#D9F5DD">[</span><span style="color:#212121;--shiki-dark:#82AAFF">d</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#1976D2;--shiki-dark:#F78C6C">0</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> for</span><span style="color:#212121;--shiki-dark:#82AAFF"> d </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">in</span><span style="color:#212121;--shiki-dark:#82AAFF"> data</span><span style="color:#212121;--shiki-dark:#D9F5DD">]</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    actions </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">array</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#D9F5DD">[</span><span style="color:#212121;--shiki-dark:#82AAFF">d</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#1976D2;--shiki-dark:#F78C6C">1</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> for</span><span style="color:#212121;--shiki-dark:#82AAFF"> d </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">in</span><span style="color:#212121;--shiki-dark:#82AAFF"> data</span><span style="color:#212121;--shiki-dark:#D9F5DD">]</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    rewards </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">array</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#D9F5DD">[</span><span style="color:#212121;--shiki-dark:#82AAFF">d</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#1976D2;--shiki-dark:#F78C6C">2</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> for</span><span style="color:#212121;--shiki-dark:#82AAFF"> d </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">in</span><span style="color:#212121;--shiki-dark:#82AAFF"> data</span><span style="color:#212121;--shiki-dark:#D9F5DD">]</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    next_states </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">array</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#D9F5DD">[</span><span style="color:#212121;--shiki-dark:#82AAFF">d</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#1976D2;--shiki-dark:#F78C6C">3</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> for</span><span style="color:#212121;--shiki-dark:#82AAFF"> d </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">in</span><span style="color:#212121;--shiki-dark:#82AAFF"> data</span><span style="color:#212121;--shiki-dark:#D9F5DD">]</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    actions_onehot </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">vmap</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">lambda</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> a</span><span style="color:#212121;--shiki-dark:#82AAFF">: jax.nn.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">one_hot</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">a</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> dynamics_model.n_actions</span><span style="color:#212121;--shiki-dark:#D6DEEB">))(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">        actions</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">    )</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    inputs </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">concatenate</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#D9F5DD">[</span><span style="color:#212121;--shiki-dark:#82AAFF">states, actions_onehot</span><span style="color:#212121;--shiki-dark:#D9F5DD">],</span><span style="color:#212121;--shiki-dark:#D7DBE0"> axis</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#F78C6C">1</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    metrics </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> LossMetrics</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">empty</span><span style="color:#212121;--shiki-dark:#D6DEEB">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">    for</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> epoch </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">in</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> range</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">n_epochs</span><span style="color:#212121;--shiki-dark:#D6DEEB">):</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        idx </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">random</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">permutation</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">jax.random.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">PRNGKey</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">epoch</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> jnp.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">arange</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#C5E478">len</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">data</span><span style="color:#212121;--shiki-dark:#D6DEEB">)))</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        batches </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">        for</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> i </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">in</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> range</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#1976D2;--shiki-dark:#F78C6C">0</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> len</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">data</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> batch_size</span><span style="color:#212121;--shiki-dark:#D6DEEB">):</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            batch_idx </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> idx</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">i </span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> i </span><span style="color:#D32F2F;--shiki-dark:#C792EA">+</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> batch_size</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            batches </span><span style="color:#D32F2F;--shiki-dark:#C792EA">+=</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            batch_inputs </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> inputs</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">batch_idx</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            batch_targets </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> next_states</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">batch_idx</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            dynamics_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> dynamics_opt_state</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> d_loss </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6"> step</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                dynamics_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                batch_inputs</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                batch_targets</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                dynamics_opt_state</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                optimizer</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">            )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            batch_rewards </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> rewards</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">batch_idx</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            reward_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> reward_opt_state</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> r_loss </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6"> step</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                reward_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> batch_inputs</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> batch_rewards</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> reward_opt_state</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> optimizer</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">            )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            metrics </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> metrics</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">merge</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                LossMetrics.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">single_from_model_output</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D7DBE0">                    dynamic_loss</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">d_loss</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> reward_loss</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">r_loss</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                )</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">            )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">    return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> dynamics_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> reward_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> metrics</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> dynamics_opt_state</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> reward_opt_state</span></span></code></pre>
<p>Finally, we train the whole thing:</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">def</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic"> model_based_rl</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    env</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_iterations</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_initial_episodes</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_model_steps</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_additional_episodes</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    epsilon</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> float</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_epochs</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    batch_size</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    learning_rate</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> float</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_horizon</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    state_dim </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> env</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">observation_space</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">shape</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#1976D2;--shiki-dark:#F78C6C">0</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    action_dim </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> env</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">action_space</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">n</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    dynamics_model </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6"> DynamicsModel</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D7DBE0">        n_dims</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#C5E478">int</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">state_dim</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> n_actions</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#C5E478">int</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">action_dim</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> key</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">jax.random.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">key</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#1976D2;--shiki-dark:#F78C6C">0</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">    )</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    reward_model </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6"> RewardModel</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D7DBE0">        n_dims</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#C5E478">int</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">state_dim</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> n_actions</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#C5E478">int</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">action_dim</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> key</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">jax.random.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">key</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#1976D2;--shiki-dark:#F78C6C">1</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">    )</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    optimizer </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> optax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">adam</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">learning_rate</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    dynamics_opt_state </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> optimizer</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">init</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">eqx.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">filter</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">dynamics_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> eqx.is_array</span><span style="color:#212121;--shiki-dark:#D6DEEB">))</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    reward_opt_state </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> optimizer</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">init</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">eqx.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">filter</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">reward_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> eqx.is_array</span><span style="color:#212121;--shiki-dark:#D6DEEB">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    data </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6"> collect_data</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">        env</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">        n_initial_episodes</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">        dynamics_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">        reward_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">        epsilon</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D7DBE0">        n_horizon</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">n_horizon</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">    )</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    reward_metrics </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> RewardMetrics</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">empty</span><span style="color:#212121;--shiki-dark:#D6DEEB">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">    for</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> iteration </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">in</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> range</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">n_iterations</span><span style="color:#212121;--shiki-dark:#D6DEEB">):</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        dynamics_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> reward_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> metrics</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> dynamics_opt_state</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> reward_opt_state </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B2CCD6">            train_models</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                data</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                dynamics_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                reward_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                n_epochs</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                batch_size</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                learning_rate</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                optimizer</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                dynamics_opt_state</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                reward_opt_state</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">            )</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        )</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        losses_computed </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> metrics</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">compute</span><span style="color:#212121;--shiki-dark:#D6DEEB">()</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        new_data </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6"> collect_data</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">            env</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">            n_additional_episodes</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">            dynamics_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">            reward_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">            epsilon</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D7DBE0">            n_horizon</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">n_horizon</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">        )</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        data</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">extend</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">new_data</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        eval_rewards </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6"> evaluate_policy</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">env</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> dynamics_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> reward_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        reward_metrics </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> reward_metrics</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">merge</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">            RewardMetrics.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">single_from_model_output</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#D7DBE0">rewards</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">eval_rewards</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">        )</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        rewards_computed </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> reward_metrics</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">compute</span><span style="color:#212121;--shiki-dark:#D6DEEB">()</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#C5E478">        print</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">losses_computed</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> rewards_computed</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">    return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> dynamics_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> reward_model</span></span></code></pre>
<p>If you train the whole thing, you will get graphs like these:</p>
<p>Dynamics loss
<img src="/posts/mb-rl-experiments/dynamic_loss.svg" alt="Dynamics Loss"></p>
<p>Rewards loss
<img src="/posts/mb-rl-experiments/reward_loss.svg" alt="Rewards Loss"></p>
<p>Rewards
<img src="/posts/mb-rl-experiments/rewards.svg" alt="Rewards"></p>
<p>Pretty bad, right? Well, yes. Let’s try to change the reward function a bit to make it dependent on the position of the cart and pole to see if that improves things.</p>
<p>Rewards (using a slightly larger dynamics model)
<img src="/posts/mb-rl-experiments/rewards_hand_crafted.svg" alt="Rewards"></p>
<p>Something definitely changed, namely the reward never dipped below 50, whereas in the previous approach with the reward model, the performance just kept getting worse. But it’s not feasible to hand craft the reward model every time. In this example it was just a simple matter of asking Claude if it can just code it out for me, but that won’t always be possible.</p>
<h2 id="little-gif">Little GIF</h2>
<p>What does the dynamics model actually predict? I collected some data for state transitions from the actual environment and what the dynamics model predicts. Have a look at these examples:</p>
<p><img src="/posts/mb-rl-experiments/gif1.gif" alt="Gif1">
<img src="/posts/mb-rl-experiments/gif2.gif" alt="Gif2"></p>
<p>I have to say I like these predictions. Sure, they are “over the top” and predict a super drastic change in the cart, but it looks like the physics kind of checks out, especially in the second GIF. Look at how if the pole is tilted to the right and if the cart moves to the right, then the pole moves to the left!</p>
<h2 id="conclusion-for-now">Conclusion (for now)</h2>
<p>This was expected. Sergey said as much in his talk in the linked video that MBRL - in this basic setting - does not work and I have to concur. But the MBRL journey is far from done. For one, we can switch CEM with MCTS to get potentially better results (for reference, AlphaGo used MCTS) but we can also use the other tricks that Sergey and their team have found. We will see about that in the next post.</p>
<h2 id="errata">Errata</h2>
<p>Ouch. I just saw that I had a major flaw in my data collection pipeline, which is the entire reason, that the dynamics model got “stuck” and didn’t improve any further beyond a loss of around <code>0.2</code>.</p>
<p>Looking at this code again</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">def</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic"> collect_data</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    env</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> gym</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">Env</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_episodes</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    dynamics_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    reward_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    epsilon</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> float</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 0.1</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_horizon</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 10</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#212121;--shiki-dark:#D6DEEB"> -></span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> list</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">tuple</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">]]</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    data </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD"> []</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">    for</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> i </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">in</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> range</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">n_episodes</span><span style="color:#212121;--shiki-dark:#D6DEEB">):</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        state</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> _ </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> env</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">reset</span><span style="color:#212121;--shiki-dark:#D6DEEB">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        terminated</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> truncated </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#FF5874"> False</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#1976D2;--shiki-dark:#FF5874"> False</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">        while</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> not</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> terminated </span><span style="color:#D32F2F;--shiki-dark:#C792EA">and</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> not</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> truncated</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">            if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> random</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">random</span><span style="color:#212121;--shiki-dark:#D6DEEB">()</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> &#x3C;</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> epsilon</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">                action </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> env</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">action_space</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">sample</span><span style="color:#212121;--shiki-dark:#D6DEEB">()</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">            else</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">                action </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B2CCD6">                    reward_model_planning</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                        dynamics_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> reward_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> state</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> n_horizon</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">n_horizon</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                    )</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                )</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            next_state</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> reward</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> terminated</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> truncated</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> _ </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> env</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">step</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">action</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            data</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">append</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">(state, action, reward, next_state)</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">    return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> data</span></span></code></pre>
<p>We can see that we predict the action like this</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B2CCD6">reward_model_planning</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">    dynamics_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> reward_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> state</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> n_horizon</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">n_horizon</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span></code></pre>
<p>But the issue is that <code>state</code> is always the initial state! It never gets updated. Furthermore, this line</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">data</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">append</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">(state, action, reward, next_state)</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span></code></pre>
<p>makes everything worse, because <code>state</code> is the initial state of the environment and <code>next_state</code> keeps changing, so it’s a miracle at all that I got some high returns at all. A simple fix for this is:</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">state </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> next_state</span></span></code></pre>
<p>With that single line added, the MBRL algorithm works and really soars:</p>
<p><img src="/posts/mb-rl-experiments/with_hand_crafted_rewards.png" alt="Rewards"></p>
<p>This is using the hand-crafted reward signal. If we run the same code again with the reward model, we can see just how badly it performs:</p>
<p><img src="/posts/mb-rl-experiments/with_reward_model_fail.png" alt="Rewards"></p>
<p>This just goes to show how important a good reward signal is during planning. In both cases, the dynamics model learned the model just fine (very low loss), but the planning is what leads to the low returns, because the reward signal is not helpful at all and is not properly guiding the planning step.</p>
<p>But you can actually remedy this by changing the way you collect the data. For instance if you used this data collection:</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">def</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic"> collect_data</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    env</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> gym</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">Env</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_episodes</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    dynamics_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    reward_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    epsilon</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> float</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 0.1</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_horizon</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 10</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    gamma</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#1976D2;--shiki-dark:#C5E478"> float</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 0.99</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#212121;--shiki-dark:#D6DEEB"> -></span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> list</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">tuple</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> Array</span><span style="color:#212121;--shiki-dark:#D6DEEB">]]</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    data </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD"> []</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">    for</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> i </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">in</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> range</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">n_episodes</span><span style="color:#212121;--shiki-dark:#D6DEEB">):</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        state</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> _ </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> env</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">reset</span><span style="color:#212121;--shiki-dark:#D6DEEB">()</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        episode_data </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        terminated</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> truncated </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#FF5874"> False</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#1976D2;--shiki-dark:#FF5874"> False</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">        while</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> not</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> terminated </span><span style="color:#D32F2F;--shiki-dark:#C792EA">and</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> not</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> truncated</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">            if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> random</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">random</span><span style="color:#212121;--shiki-dark:#D6DEEB">()</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> &#x3C;</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> epsilon</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">                action </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> env</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">action_space</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">sample</span><span style="color:#212121;--shiki-dark:#D6DEEB">()</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">            else</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">                action </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#C5E478"> int</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B2CCD6">                    reward_model_planning</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                        dynamics_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> reward_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> state</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> n_horizon</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">n_horizon</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                    )</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                )</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            next_state</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> reward</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> terminated</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> truncated</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> _ </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> env</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">step</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">action</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            episode_data</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">append</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">(state, action, reward, next_state)</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            state </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> next_state</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C2C3C5;font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic">        # Calculate returns</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        returns </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD"> []</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        G </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 0</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">        for</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> s</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> a</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> r</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> ns </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">in</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> reversed</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">episode_data</span><span style="color:#212121;--shiki-dark:#D6DEEB">):</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            G </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> r </span><span style="color:#D32F2F;--shiki-dark:#C792EA">+</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> gamma </span><span style="color:#D32F2F;--shiki-dark:#C792EA">*</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> G</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            returns</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">insert</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#1976D2;--shiki-dark:#F78C6C">0</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> G</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">        if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> returns</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            max_return </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> max</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">returns</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            min_return </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> min</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">returns</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#C2C3C5;font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic">            # Avoid division by zero</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">            if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> max_return </span><span style="color:#D32F2F;--shiki-dark:#C792EA">></span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> min_return</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">                normalized_returns </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD"> [</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">                    (r </span><span style="color:#D32F2F;--shiki-dark:#C792EA">-</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> min_return) </span><span style="color:#D32F2F;--shiki-dark:#C792EA">/</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (max_return </span><span style="color:#D32F2F;--shiki-dark:#C792EA">-</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> min_return) </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">for</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> r </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">in</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> returns</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D9F5DD">                ]</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">            else</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">                normalized_returns </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD"> [</span><span style="color:#1976D2;--shiki-dark:#F78C6C">1.0</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> for</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> _ </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">in</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> returns</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">]</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">        else</span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            normalized_returns </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">        for</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (s</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> a</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> r</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> ns)</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> g </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">in</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> zip</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">episode_data</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> normalized_returns</span><span style="color:#212121;--shiki-dark:#D6DEEB">):</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            data</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">append</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">(s, a, r, ns, g)</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">    return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> data</span></span></code></pre>
<p>Then you would calculate the expected future rewards given a state <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span>. This way, you introduce the idea that if the pole is upright in the middle, then this will likely yield higher results in the future. Then, of course, you have to change the training part a bit:</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">def</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic"> train_models</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    data</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    dynamics_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    reward_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    n_epochs</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    batch_size</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    learning_rate</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    optimizer</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    dynamics_opt_state</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#FF9800;--shiki-dark:#7FDBCA">    reward_opt_state</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">:</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    states </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">array</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#D9F5DD">[</span><span style="color:#212121;--shiki-dark:#82AAFF">d</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#1976D2;--shiki-dark:#F78C6C">0</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> for</span><span style="color:#212121;--shiki-dark:#82AAFF"> d </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">in</span><span style="color:#212121;--shiki-dark:#82AAFF"> data</span><span style="color:#212121;--shiki-dark:#D9F5DD">]</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    actions </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">array</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#D9F5DD">[</span><span style="color:#212121;--shiki-dark:#82AAFF">d</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#1976D2;--shiki-dark:#F78C6C">1</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> for</span><span style="color:#212121;--shiki-dark:#82AAFF"> d </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">in</span><span style="color:#212121;--shiki-dark:#82AAFF"> data</span><span style="color:#212121;--shiki-dark:#D9F5DD">]</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    rewards </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">array</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#D9F5DD">[</span><span style="color:#212121;--shiki-dark:#82AAFF">d</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#1976D2;--shiki-dark:#F78C6C">2</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> for</span><span style="color:#212121;--shiki-dark:#82AAFF"> d </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">in</span><span style="color:#212121;--shiki-dark:#82AAFF"> data</span><span style="color:#212121;--shiki-dark:#D9F5DD">]</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    next_states </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">array</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#D9F5DD">[</span><span style="color:#212121;--shiki-dark:#82AAFF">d</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#1976D2;--shiki-dark:#F78C6C">3</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> for</span><span style="color:#212121;--shiki-dark:#82AAFF"> d </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">in</span><span style="color:#212121;--shiki-dark:#82AAFF"> data</span><span style="color:#212121;--shiki-dark:#D9F5DD">]</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    returns </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">array</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#D9F5DD">[</span><span style="color:#212121;--shiki-dark:#82AAFF">d</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#1976D2;--shiki-dark:#F78C6C">4</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> for</span><span style="color:#212121;--shiki-dark:#82AAFF"> d </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">in</span><span style="color:#212121;--shiki-dark:#82AAFF"> data</span><span style="color:#212121;--shiki-dark:#D9F5DD">]</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    actions_onehot </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">vmap</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">lambda</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> a</span><span style="color:#212121;--shiki-dark:#82AAFF">: jax.nn.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">one_hot</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">a</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> dynamics_model.n_actions</span><span style="color:#212121;--shiki-dark:#D6DEEB">))(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">        actions</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">    )</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    inputs </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jnp</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">concatenate</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#D9F5DD">[</span><span style="color:#212121;--shiki-dark:#82AAFF">states, actions_onehot</span><span style="color:#212121;--shiki-dark:#D9F5DD">],</span><span style="color:#212121;--shiki-dark:#D7DBE0"> axis</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#F78C6C">1</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    metrics </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> LossMetrics</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">empty</span><span style="color:#212121;--shiki-dark:#D6DEEB">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">    for</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> epoch </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">in</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> range</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">n_epochs</span><span style="color:#212121;--shiki-dark:#D6DEEB">):</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        idx </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> jax</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">random</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">permutation</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">jax.random.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">PRNGKey</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">epoch</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> jnp.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">arange</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#C5E478">len</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">data</span><span style="color:#212121;--shiki-dark:#D6DEEB">)))</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        batches </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">        for</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> i </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">in</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> range</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#1976D2;--shiki-dark:#F78C6C">0</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> len</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#212121;--shiki-dark:#82AAFF">data</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> batch_size</span><span style="color:#212121;--shiki-dark:#D6DEEB">):</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            batch_idx </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> idx</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">i </span><span style="color:#212121;--shiki-dark:#D6DEEB">:</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> i </span><span style="color:#D32F2F;--shiki-dark:#C792EA">+</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> batch_size</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            batches </span><span style="color:#D32F2F;--shiki-dark:#C792EA">+=</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            batch_inputs </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> inputs</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">batch_idx</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            batch_targets </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> next_states</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">batch_idx</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            dynamics_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> dynamics_opt_state</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> d_loss </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6"> step</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                dynamics_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                batch_inputs</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                batch_targets</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                dynamics_opt_state</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                optimizer</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">            )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            batch_returns </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> returns</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">batch_idx</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            reward_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> reward_opt_state</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> r_loss </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6"> step</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                reward_model</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> batch_inputs</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> batch_returns</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> reward_opt_state</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#82AAFF"> optimizer</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">            )</span><span style="color:#C2C3C5;font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic"> # train on the returns now!</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            metrics </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> metrics</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">merge</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                LossMetrics.</span><span style="color:#6F42C1;--shiki-dark:#B2CCD6">single_from_model_output</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D7DBE0">                    dynamic_loss</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">d_loss</span><span style="color:#212121;--shiki-dark:#D9F5DD">,</span><span style="color:#212121;--shiki-dark:#D7DBE0"> reward_loss</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#212121;--shiki-dark:#82AAFF">r_loss</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                )</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">            )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">    return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> dynamics_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> reward_model</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> metrics</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> dynamics_opt_state</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> reward_opt_state</span></span></code></pre>
<p>When you do this instead, the model solves the environment as well:</p>
<p><img src="/posts/mb-rl-experiments/with_reward_model_success.png" alt="Rewards"></p> </article> </div> <div class="h-[25rem]"></div> </body></html>